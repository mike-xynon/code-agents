version: '3.8'

services:
  # Nginx Reverse Proxy
  # Single entry point on port 8080
  nginx:
    image: nginx:alpine
    container_name: claude-farm-nginx
    ports:
      - "8080:8080"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - dashboard
    networks:
      - claude-farm-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # Redis for state management (optional but recommended)
  redis:
    image: redis:7-alpine
    container_name: claude-farm-redis
    volumes:
      - redis-data:/data
    networks:
      - claude-farm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Dashboard - Flask web UI
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: claude-farm-dashboard
    environment:
      - WORKER_IMAGE=claude-worker:latest
      - NETWORK_NAME=claude-farm-network
      - SHARED_REPOS_VOLUME=docker-claude-farm_shared-repos
      - SHARED_STATE_VOLUME=docker-claude-farm_shared-state
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - BASE_PORT=7681
      - MAX_WORKERS=20
      - NGINX_HOST=${NGINX_HOST:-localhost}
      - NGINX_PORT=8080
      - REDIS_URL=redis://redis:6379
      - SSH_SECRETS_HOST_PATH=${SSH_SECRETS_HOST_PATH:-}
      - API_SECRETS_HOST_PATH=${API_SECRETS_HOST_PATH:-}
    volumes:
      # Mount Docker socket to manage containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount SSH secrets for git clone
      - ./secrets/ssh:/secrets/ssh:ro
      # Mount repos config for bootstrap
      - ./repos.json:/app/repos.json:ro
    depends_on:
      - redis
    networks:
      - claude-farm-network
    restart: unless-stopped

# Note: Worker containers are created dynamically by the dashboard
# They use the claude-worker:latest image and connect to the network

networks:
  claude-farm-network:
    name: claude-farm-network
    driver: bridge

volumes:
  # Shared storage for worker repositories
  shared-repos:
    name: docker-claude-farm_shared-repos

  # Shared state storage
  shared-state:
    name: docker-claude-farm_shared-state

  # Redis persistence
  redis-data:
    name: docker-claude-farm_redis-data
